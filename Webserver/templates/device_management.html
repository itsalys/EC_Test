{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Device Management</h2>

    <button class="btn btn-primary mb-3" id="refreshDevicesBtn" disabled>Refresh Devices</button>
    <div class="text-muted mb-2" id="lastRefreshed">Last refreshed: --</div>

    <div id="scanningIndicator" class="alert alert-info" style="display: none;">
        Scanning for devices... please wait.
    </div>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Hostname</th>
                <th>IP Address</th>
                <th>Mode</th>
            </tr>
        </thead>
        <tbody id="device-table">
            <tr>
                <td colspan="3" class="text-center text-muted">No devices loaded.</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("token");
    const refreshBtn = document.getElementById("refreshDevicesBtn");
    const tableBody = document.getElementById("device-table");
    const scanningIndicator = document.getElementById("scanningIndicator");
    const lastRefreshed = document.getElementById("lastRefreshed");

    if (!token) {
        window.location.href = "/auth/admin/login";
        return;
    }

    const formattedToken = token.startsWith("Bearer ") ? token : `Bearer ${token}`;

    fetch("/auth/admin/verify", {
        method: "GET",
        headers: {
            "Authorization": formattedToken,
            "Content-Type": "application/json"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            window.location.href = "/auth/admin/login";
        } else {
            refreshBtn.disabled = false;
            scanAndLoadDevices();
        }
    });

    function updateDeviceMode(hostname, newMode) {
        fetch(`/devices/update_mode`, {
            method: "POST",
            headers: {
                "Authorization": formattedToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ hostname, mode: newMode })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert("Failed to update mode: " + data.error);
            } else {
                console.log("Mode updated successfully");
            }
        })
        .catch(err => {
            alert("Failed to send update request");
        });
    }

    function scanAndLoadDevices() {
        scanningIndicator.style.display = "block";
        tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-info">Waiting for devices to respond...</td></tr>`;
        lastRefreshed.innerText = "Last refreshed: --";

        fetch("/devices/trigger", {
            method: "POST",
            headers: {
                "Authorization": formattedToken,
                "Content-Type": "application/json"
            }
        });

        setTimeout(() => {
            fetch("/devices/", {
                method: "GET",
                headers: {
                    "Authorization": formattedToken,
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                scanningIndicator.style.display = "none";
                tableBody.innerHTML = "";

                if (data.error || !data.devices || data.devices.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">${data.error || "No devices found."}</td></tr>`;
                    return;
                }

                data.devices.forEach(device => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${device.hostname}</td>
                        <td>${device.ip_address}</td>
                        <td>
                            <select class="form-select mode-selector" data-hostname="${device.hostname}">
                                <option value="entry" ${device.mode === "entry" ? "selected" : ""}>entry</option>
                                <option value="exit" ${device.mode === "exit" ? "selected" : ""}>exit</option>
                            </select>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll(".mode-selector").forEach(select => {
                    select.addEventListener("change", function () {
                        const hostname = this.dataset.hostname;
                        const mode = this.value;
                        updateDeviceMode(hostname, mode);
                    });
                });

                lastRefreshed.innerText = "Last refreshed: " + new Date().toLocaleTimeString();
            })
            .catch(err => {
                scanningIndicator.style.display = "none";
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Failed to fetch device list.</td></tr>`;
            });
        }, 3000);
    }

    refreshBtn.addEventListener("click", scanAndLoadDevices);
});
</script>
{% endblock %}
