{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Device Management</h2>

    <button class="btn btn-primary mb-3" id="refreshDevicesBtn" disabled>Refresh Devices</button>
    <div class="text-muted mb-2" id="lastRefreshed">Last refreshed: --</div>

    <div id="scanningIndicator" class="alert alert-info" style="display: none;">
        Scanning for devices... please wait.
    </div>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Hostname</th>
                <th>IP Address</th>
                <th>Mode</th>
            </tr>
        </thead>
        <tbody id="device-table">
            <tr>
                <td colspan="3" class="text-center text-muted">No devices loaded.</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("token");
    const refreshBtn = document.getElementById("refreshDevicesBtn");
    const tableBody = document.getElementById("device-table");
    const scanningIndicator = document.getElementById("scanningIndicator");
    const lastRefreshed = document.getElementById("lastRefreshed");

    if (!token) {
        console.error("No token found. Redirecting...");
        window.location.href = "/auth/admin/login";
        return;
    }

    const formattedToken = token.startsWith("Bearer ") ? token : `Bearer ${token}`;

    fetch("/auth/admin/verify", {
        method: "GET",
        headers: {
            "Authorization": formattedToken,
            "Content-Type": "application/json"
        },
        mode: "cors",
        credentials: "include"
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error("Invalid token. Redirecting...");
            window.location.href = "/auth/admin/login";
        } else {
            refreshBtn.disabled = false;
            scanAndLoadDevices();
        }
    })
    .catch(() => {
        window.location.href = "/auth/admin/login";
    });

    function scanAndLoadDevices() {
        scanningIndicator.style.display = "block";
        tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-info">Waiting for devices to respond...</td></tr>`;
        lastRefreshed.innerText = "Last refreshed: --";

        fetch("/devices/trigger", {
            method: "POST",
            headers: {
                "Authorization": formattedToken,
                "Content-Type": "application/json"
            }
        });

        setTimeout(() => {
            fetch("/devices/", {
                method: "GET",
                headers: {
                    "Authorization": formattedToken,
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                scanningIndicator.style.display = "none";
                tableBody.innerHTML = "";

                if (data.error || !data.devices || data.devices.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">${data.error || "No devices found."}</td></tr>`;
                    return;
                }

                data.devices.forEach(device => {
                    const row = `<tr>
                        <td>${device.hostname}</td>
                        <td>${device.ip_address}</td>
                        <td>
                            <select class="form-select mode-dropdown" data-hostname="${device.hostname}">
                                <option value="entry" ${device.mode === "entry" ? "selected" : ""}>Entry</option>
                                <option value="exit" ${device.mode === "exit" ? "selected" : ""}>Exit</option>
                            </select>
                            <div class="status small text-muted" id="status-${device.hostname}"></div>
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });

                lastRefreshed.innerText = "Last refreshed: " + new Date().toLocaleTimeString();
            })
            .catch(() => {
                scanningIndicator.style.display = "none";
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Failed to fetch device list.</td></tr>`;
            });
        }, 3000);
    }

    refreshBtn.addEventListener("click", scanAndLoadDevices);

    document.addEventListener("change", function (e) {
        if (e.target.classList.contains("mode-dropdown")) {
            const hostname = e.target.getAttribute("data-hostname");
            const newMode = e.target.value;
            const statusDiv = document.getElementById(`status-${hostname}`);
            statusDiv.textContent = "Updating...";

            fetch(`/devices/${hostname}/mode`, {
                method: "POST",
                headers: {
                    "Authorization": formattedToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ mode: newMode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    statusDiv.textContent = "Mode updated";
                    statusDiv.classList.add("text-success");
                    statusDiv.classList.remove("text-danger");
                } else {
                    throw new Error(data.error || "Update failed");
                }
            })
            .catch(() => {
                statusDiv.textContent = "Update failed";
                statusDiv.classList.add("text-danger");
                statusDiv.classList.remove("text-success");
            });
        }
    });
});
</script>
{% endblock %}
