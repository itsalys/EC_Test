{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Device Management</h2>

    <button class="btn btn-primary mb-3" id="refreshDevicesBtn" disabled>Refresh Devices</button>
    <div class="text-muted mb-2" id="lastRefreshed">Last refreshed: --</div>

    <div id="scanningIndicator" class="alert alert-info" style="display: none;">
        Scanning for devices... please wait.
    </div>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Hostname</th>
                <th>IP Address</th>
                <th>Mode</th>
            </tr>
        </thead>
        <tbody id="device-table">
            <tr>
                <td colspan="3" class="text-center text-muted">No devices loaded.</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Modal for update feedback -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">Updating Device</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalBody">
        Sending update request...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("token");
    const refreshBtn = document.getElementById("refreshDevicesBtn");
    const tableBody = document.getElementById("device-table");
    const scanningIndicator = document.getElementById("scanningIndicator");
    const lastRefreshed = document.getElementById("lastRefreshed");

    if (!token) {
        window.location.href = "/auth/admin/login";
        return;
    }

    const formattedToken = token.startsWith("Bearer ") ? token : `Bearer ${token}`;

    fetch("/auth/admin/verify", {
        method: "GET",
        headers: {
            "Authorization": formattedToken,
            "Content-Type": "application/json"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            window.location.href = "/auth/admin/login";
        } else {
            refreshBtn.disabled = false;
            scanAndLoadDevices();
        }
    });

    function updateDeviceMode(hostname, newMode) {
        const modal = new bootstrap.Modal(document.getElementById("updateModal"));
        document.getElementById("modalBody").innerText = `Updating device \"${hostname}\" to mode \"${newMode}\"...`;
        modal.show();

        fetch(`/devices/update_mode`, {
            method: "POST",
            headers: {
                "Authorization": formattedToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ hostname, mode: newMode })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                document.getElementById("modalBody").innerText = `Error: ${data.error}`;
                return;
            }

            const responseTopic = `app/update_device/${hostname}/response`;
            const mqttClient = mqtt.connect("ws://localhost:9001");

            mqttClient.on("connect", () => {
                mqttClient.subscribe(responseTopic);
            });

            mqttClient.on("message", (topic, message) => {
                if (topic === responseTopic) {
                    const resp = JSON.parse(message.toString());
                    document.getElementById("modalBody").innerText =
                        resp.status === "success"
                            ? `Success: ${resp.message}`
                            : `Error: ${resp.message}`;
                    mqttClient.end();
                }
            });

            setTimeout(() => {
                document.getElementById("modalBody").innerText = "Timeout: No response from device.";
                mqttClient.end();
            }, 5000);
        })
        .catch(err => {
            document.getElementById("modalBody").innerText = "Failed to send update request";
        });
    }

    function scanAndLoadDevices() {
        scanningIndicator.style.display = "block";
        tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-info">Waiting for devices to respond...</td></tr>`;
        lastRefreshed.innerText = "Last refreshed: --";

        fetch("/devices/trigger", {
            method: "POST",
            headers: {
                "Authorization": formattedToken,
                "Content-Type": "application/json"
            }
        });

        setTimeout(() => {
            fetch("/devices/", {
                method: "GET",
                headers: {
                    "Authorization": formattedToken,
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                scanningIndicator.style.display = "none";
                tableBody.innerHTML = "";

                if (data.error || !data.devices || data.devices.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">${data.error || "No devices found."}</td></tr>`;
                    return;
                }

                data.devices.forEach(device => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${device.hostname}</td>
                        <td>${device.ip_address}</td>
                        <td>
                            <select class="form-select mode-selector" data-hostname="${device.hostname}">
                                <option value="entry" ${device.mode === "entry" ? "selected" : ""}>entry</option>
                                <option value="exit" ${device.mode === "exit" ? "selected" : ""}>exit</option>
                            </select>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll(".mode-selector").forEach(select => {
                    select.addEventListener("change", function () {
                        const hostname = this.dataset.hostname;
                        const mode = this.value;
                        updateDeviceMode(hostname, mode);
                    });
                });

                lastRefreshed.innerText = "Last refreshed: " + new Date().toLocaleTimeString();
            })
            .catch(err => {
                scanningIndicator.style.display = "none";
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Failed to fetch device list.</td></tr>`;
            });
        }, 3000);
    }

    refreshBtn.addEventListener("click", scanAndLoadDevices);
});
</script>
{% endblock %}